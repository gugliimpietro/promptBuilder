<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Veo JSON Prompt Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6;
      }
      .json-key {
        color: #9b59b6;
      }
      .json-string {
        color: #2ecc71;
      }
      .json-number {
        color: #e67e22;
      }
      .json-boolean {
        color: #3498db;
      }
      .json-null {
        color: #c0392b;
      }
      .form-section {
        background-color: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1),
          0 2px 4px -2px rgb(0 0 0 / 0.1);
        transition: all 0.3s ease-in-out;
      }
      .form-section:hover {
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1),
          0 4px 6px -4px rgb(0 0 0 / 0.1);
      }
      .form-label {
        font-weight: 500;
        color: #4b5563;
      }
      .form-input,
      .form-select {
        width: 100%;
        border-radius: 0.5rem;
        border: 1px solid #d1d5db;
        padding: 0.75rem 1rem;
        margin-top: 0.5rem;
        transition: border-color 0.2s, box-shadow 0.2s;
        background-color: #fff; /* Ensure select has a background */
      }
      .form-input:focus,
      .form-select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgb(59 130 246 / 0.5);
      }
      .add-btn {
        background-color: #10b981;
        color: white;
      }
      .remove-btn {
        background-color: #ef4444;
        color: white;
      }
      #json-output-container {
        position: sticky;
        top: 1.5rem;
      }
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
      }
      .small-loader {
        width: 16px;
        height: 16px;
        border-width: 2px;
      }
      .image-container .loader {
        width: 40px;
        height: 40px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="p-6 lg:p-8">
    <header class="text-center mb-8">
      <h1 class="text-4xl font-bold text-gray-800">Veo JSON Prompt Builder</h1>
      <p class="text-lg text-gray-600 mt-2">
        Visually construct detailed prompts for consistent AI video generation.
      </p>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Input Form Column -->
      <div id="form-container">
        <!-- Scene Description AI Filler -->
        <div class="form-section bg-indigo-50 border border-indigo-200">
          <h2
            class="text-2xl font-semibold text-gray-700 mb-4 flex items-center"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="mr-2 text-indigo-600"
            >
              <path
                d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"
              />
              <path d="M5 3v4" />
              <path d="M19 17v4" />
              <path d="M3 5h4" />
              <path d="M17 19h4" />
            </svg>
            AI Scene Assistant
          </h2>
          <div>
            <label for="scene-description" class="form-label"
              >Describe your scene here:</label
            >
            <textarea
              id="scene-description"
              rows="4"
              class="form-input"
              placeholder="e.g., A cinematic wide shot of a grizzled detective named Kaito standing on a rainy, neon-lit street in Tokyo at midnight. He's wearing a long trench coat. The scene should feel like a film noir."
            ></textarea>
            <button
              id="generate-details"
              class="w-full mt-4 py-2.5 px-4 rounded-lg font-semibold bg-indigo-600 text-white hover:bg-indigo-700 transition-colors flex items-center justify-center disabled:bg-indigo-400"
            >
              <span id="generate-btn-text"
                >âœ¨ Generate Details & Scene Image</span
              >
              <div id="generate-loader" class="loader hidden ml-2"></div>
            </button>
            <p id="api-error" class="text-red-600 text-sm mt-2 text-center"></p>
          </div>
        </div>

        <!-- Image Reference Section -->
        <div class="form-section">
          <h2
            class="text-2xl font-semibold text-gray-700 mb-4 flex items-center"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="mr-2"
            >
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <circle cx="8.5" cy="8.5" r="1.5"></circle>
              <polyline points="21 15 16 10 5 21"></polyline>
            </svg>
            Scene Image Reference
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
            <div>
              <label for="image-prompt" class="form-label"
                >Image Prompt (auto-filled from scene):</label
              >
              <textarea
                id="image-prompt"
                rows="5"
                class="form-input"
                placeholder="e.g., Portrait of a grizzled Japanese detective, 40s, tired eyes, 5 o'clock shadow, film noir style, high detail."
              ></textarea>
              <div class="flex items-center gap-2 mt-4">
                <button
                  id="generate-image"
                  class="w-full py-2.5 px-4 rounded-lg font-semibold bg-green-600 text-white hover:bg-green-700 transition-colors flex items-center justify-center disabled:bg-green-400"
                >
                  <span class="btn-text">ðŸŽ¨ Regenerate</span>
                  <div class="loader hidden ml-2"></div>
                </button>
                <a
                  id="download-image-link"
                  href="#"
                  download="scene-image.png"
                  class="w-full py-2.5 px-4 rounded-lg font-semibold bg-blue-600 text-white hover:bg-blue-700 transition-colors flex items-center justify-center hidden"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="mr-2"
                  >
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                  </svg>
                  <span>Download</span>
                </a>
              </div>
            </div>
            <div
              id="image-container"
              class="w-full h-64 bg-gray-100 rounded-lg flex items-center justify-center border-2 border-dashed"
            >
              <img
                id="generated-image"
                src=""
                alt="Generated Character"
                class="hidden w-full h-full object-cover rounded-lg"
              />
              <div id="image-loader" class="loader hidden"></div>
              <p id="image-placeholder" class="text-gray-500 text-center p-4">
                Your generated scene image will appear here.
              </p>
            </div>
          </div>
          <div class="mt-4">
            <label for="reference_image_url" class="form-label"
              >Reference Image URL</label
            >
            <input
              type="text"
              id="reference_image_url"
              class="form-input"
              placeholder="Auto-filled by image generator, or paste your own URL."
            />
          </div>
        </div>

        <!-- Action Section -->
        <div class="form-section">
          <h2
            class="text-2xl font-semibold text-gray-700 mb-4 flex items-center"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="mr-2"
            >
              <path d="M15 18H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h12v12Z" />
              <path d="M21 12v6a2 2 0 0 1-2 2H9" />
              <path d="m14 10 3-3 3 3" />
              <path d="M17 7v9" />
            </svg>
            Main Action & Scene
          </h2>
          <div>
            <label for="action" class="form-label"
              >Describe the main action of this scene:</label
            >
            <textarea
              id="action"
              rows="4"
              class="form-input"
              placeholder="e.g., A character walks through a bustling market, looking at the stalls."
            ></textarea>
          </div>
        </div>

        <!-- Character Section -->
        <div class="form-section">
          <h2
            class="text-2xl font-semibold text-gray-700 mb-4 flex items-center"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="mr-2"
            >
              <circle cx="12" cy="8" r="5" />
              <path d="M20 21a8 8 0 1 0-16 0" />
            </svg>
            Characters
          </h2>
          <div id="characters-container">
            <!-- Character blocks will be dynamically added here -->
          </div>
          <button
            id="add-character"
            class="w-full mt-4 py-2 px-4 rounded-lg font-semibold add-btn hover:bg-emerald-600 transition-colors flex items-center justify-center"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="mr-2"
            >
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Add Character
          </button>
        </div>

        <!-- Environment Section -->
        <div class="form-section">
          <h2
            class="text-2xl font-semibold text-gray-700 mb-4 flex items-center"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="mr-2"
            >
              <path d="m2 9 3-3 3 3" />
              <path d="m16 2 3 3-3 3" />
              <path d="M18 19 2 5" />
              <path d="m6 13 12 12" />
            </svg>
            Environment
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="location" class="form-label">Location</label>
              <input
                type="text"
                id="location"
                class="form-input"
                placeholder="e.g., A futuristic cyberpunk city"
              />
            </div>
            <div>
              <label for="time_of_day" class="form-label">Time of Day</label>
              <input
                type="text"
                id="time_of_day"
                class="form-input"
                placeholder="e.g., Dusk, raining"
              />
            </div>
          </div>
          <div class="mt-4">
            <label for="atmosphere" class="form-label">Atmosphere</label>
            <input
              type="text"
              id="atmosphere"
              class="form-input"
              placeholder="e.g., Moody, neon-lit, oppressive"
            />
          </div>
          <div class="mt-4">
            <label for="props" class="form-label">Key Props</label>
            <input
              type="text"
              id="props"
              class="form-input"
              placeholder="e.g., Flying vehicles, holographic ads, steaming food stalls"
            />
          </div>
        </div>

        <!-- Cinematography Section -->
        <div class="form-section">
          <h2
            class="text-2xl font-semibold text-gray-700 mb-4 flex items-center"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="mr-2"
            >
              <rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect>
              <path d="M17 2v4" />
              <path d="M7 2v4" />
            </svg>
            Cinematography
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="shot_type" class="form-label">Shot Type</label>
              <input
                type="text"
                id="shot_type"
                class="form-input"
                placeholder="e.g., Wide shot, Medium close-up"
              />
            </div>
            <div>
              <label for="camera_motion" class="form-label"
                >Camera Motion</label
              >
              <input
                type="text"
                id="camera_motion"
                class="form-input"
                placeholder="e.g., Slow dolly forward, Handheld"
              />
            </div>
            <div>
              <label for="lighting" class="form-label">Lighting</label>
              <input
                type="text"
                id="lighting"
                class="form-input"
                placeholder="e.g., High contrast, volumetric light"
              />
            </div>
            <div>
              <label for="style" class="form-label">Visual Style</label>
              <select id="style" class="form-select">
                <option value="Cinematic">Cinematic</option>
                <option value="Realistic">Realistic</option>
                <option value="Animation">Animation (General)</option>
                <option value="Ghibli Style">Ghibli Style</option>
                <option value="Lego Animation">Lego Animation</option>
                <option value="Anime">Anime</option>
                <option value="Pixel Art">Pixel Art</option>
                <option value="Claymation">Claymation</option>
                <option value="Film Noir">Film Noir</option>
                <option value="Documentary">Documentary</option>
                <option value="Vaporwave">Vaporwave</option>
                <option value="Other">Other (Specify)</option>
              </select>
              <input
                type="text"
                id="style_other"
                class="form-input mt-2 hidden"
                placeholder="Specify other style"
              />
            </div>
          </div>
          <div class="mt-4">
            <label for="color_palette" class="form-label">Color Palette</label>
            <input
              type="text"
              id="color_palette"
              class="form-input"
              placeholder="e.g., Dominated by blues, purples, and magenta neons"
            />
          </div>
        </div>

        <!-- Audio Section -->
        <div class="form-section">
          <h2
            class="text-2xl font-semibold text-gray-700 mb-4 flex items-center"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="mr-2"
            >
              <path
                d="M12 2c-4.42 0-8 3.58-8 8v6c0 1.1.9 2 2 2h4v-5h4v5h4c1.1 0 2-.9 2-2v-6c0-4.42-3.58-8-8-8Z"
              />
              <path d="M16 16.5a4.5 4.5 0 1 1-9 0" />
            </svg>
            Audio
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="dialogue_character" class="form-label"
                >Dialogue Character</label
              >
              <input
                type="text"
                id="dialogue_character"
                class="form-input"
                placeholder="e.g., Elara (or leave blank)"
              />
            </div>
            <div class="relative">
              <label for="dialogue_line" class="form-label"
                >Dialogue Line</label
              >
              <input
                type="text"
                id="dialogue_line"
                class="form-input"
                placeholder="e.g., 'I need to find the source.'"
              />
              <button
                id="suggest-dialogue"
                class="absolute right-1 bottom-1 text-xs bg-purple-600 text-white font-semibold py-1 px-2 rounded hover:bg-purple-700 transition-colors disabled:bg-purple-300"
              >
                <span class="btn-text">âœ¨ Suggest</span>
                <div class="loader small-loader hidden"></div>
              </button>
            </div>
          </div>
          <div class="mt-4">
            <label for="sound_effects" class="form-label">Sound Effects</label>
            <input
              type="text"
              id="sound_effects"
              class="form-input"
              placeholder="e.g., Sound of rain, distant sirens, sizzle of food"
            />
          </div>
          <div class="mt-4">
            <label for="ambient_noise" class="form-label"
              >Ambient Noise / Music</label
            >
            <input
              type="text"
              id="ambient_noise"
              class="form-input"
              placeholder="e.g., Synthesizer score, faint crowd chatter"
            />
          </div>
        </div>
      </div>

      <!-- Output JSON Column -->
      <div id="json-output-container">
        <div class="form-section">
          <h2 class="text-2xl font-semibold text-gray-700 mb-4">
            Generated JSON Prompt
          </h2>
          <div
            class="relative bg-gray-900 text-white p-4 rounded-lg h-auto min-h-[500px] overflow-x-auto"
          >
            <button
              id="copy-json"
              class="absolute top-3 right-3 bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 rounded-md text-sm font-semibold transition-colors"
            >
              Copy
            </button>
            <pre><code id="json-output"></code></pre>
          </div>
          <p
            id="copy-feedback"
            class="text-center text-green-600 font-medium mt-4 h-5"
          ></p>
        </div>
      </div>
    </main>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Element selectors
        const formContainer = document.getElementById("form-container");
        const jsonOutput = document.getElementById("json-output");
        const addCharacterBtn = document.getElementById("add-character");
        const charactersContainer = document.getElementById(
          "characters-container"
        );
        const copyJsonBtn = document.getElementById("copy-json");
        const copyFeedback = document.getElementById("copy-feedback");
        const generateDetailsBtn = document.getElementById("generate-details");
        const sceneDescriptionInput =
          document.getElementById("scene-description");
        const generateBtnText = document.getElementById("generate-btn-text");
        const generateLoader = document.getElementById("generate-loader");
        const suggestDialogueBtn = document.getElementById("suggest-dialogue");
        const apiError = document.getElementById("api-error");
        const styleSelect = document.getElementById("style");
        const styleOtherInput = document.getElementById("style_other");
        const generateImageBtn = document.getElementById("generate-image");
        const imagePromptInput = document.getElementById("image-prompt");
        const generatedImage = document.getElementById("generated-image");
        const imageLoader = document.getElementById("image-loader");
        const imagePlaceholder = document.getElementById("image-placeholder");
        const imageUrlInput = document.getElementById("reference_image_url");
        const downloadImageLink = document.getElementById(
          "download-image-link"
        );

        let characterCount = 0;
        let promptData = {};

        const apiKey = ""; // Canvas will provide this
        const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const nanaBananaApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;

        // Function to highlight JSON syntax
        function syntaxHighlight(json) {
          if (typeof json != "string") {
            json = JSON.stringify(json, undefined, 2);
          }
          json = json
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
          return json.replace(
            /("(\\u[azA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
            function (match) {
              let cls = "json-number";
              if (/^"/.test(match)) {
                if (/:$/.test(match)) {
                  cls = "json-key";
                } else {
                  cls = "json-string";
                }
              } else if (/true|false/.test(match)) {
                cls = "json-boolean";
              } else if (/null/.test(match)) {
                cls = "json-null";
              }
              return '<span class="' + cls + '">' + match + "</span>";
            }
          );
        }

        // Update the JSON output from form fields
        function updateJsonOutput() {
          promptData.reference_image_url = imageUrlInput.value;
          promptData.scene_details = {
            action: document.getElementById("action").value,
          };
          promptData.characters = Array.from(
            charactersContainer.querySelectorAll(".character-block")
          ).map((block) => ({
            name: block.querySelector(`[data-prop='name']`).value,
            description: block.querySelector(`[data-prop='description']`).value,
            wardrobe: block.querySelector(`[data-prop='wardrobe']`).value,
          }));
          promptData.environment = {
            location: document.getElementById("location").value,
            time_of_day: document.getElementById("time_of_day").value,
            atmosphere: document.getElementById("atmosphere").value,
            props: document.getElementById("props").value,
          };

          let styleValue = styleSelect.value;
          if (styleValue === "Other") {
            styleValue = styleOtherInput.value;
          }

          promptData.cinematography = {
            shot_type: document.getElementById("shot_type").value,
            camera_motion: document.getElementById("camera_motion").value,
            lighting: document.getElementById("lighting").value,
            style: styleValue,
            color_palette: document.getElementById("color_palette").value,
          };
          promptData.audio = {
            dialogue: {
              character: document.getElementById("dialogue_character").value,
              line: document.getElementById("dialogue_line").value,
            },
            sound_effects: document.getElementById("sound_effects").value,
            ambient_noise: document.getElementById("ambient_noise").value,
          };

          const cleanData = JSON.parse(
            JSON.stringify(promptData),
            (key, value) => {
              if (
                value === null ||
                value === "" ||
                (typeof value === "object" &&
                  Object.keys(value).length === 0 &&
                  !(value instanceof Array))
              )
                return undefined;
              if (Array.isArray(value))
                return value.filter(
                  (item) =>
                    item &&
                    (typeof item !== "object" ||
                      (Object.keys(item).length > 0 &&
                        Object.values(item).some((v) => v !== "")))
                );
              return value;
            }
          );

          jsonOutput.innerHTML = syntaxHighlight(cleanData);
        }

        // Add a new character block
        function addCharacter(
          char = { name: "", description: "", wardrobe: "" }
        ) {
          characterCount++;
          const charId = `char-${characterCount}`;
          const characterBlock = document.createElement("div");
          characterBlock.className =
            "character-block border border-gray-200 p-4 rounded-lg mt-4";
          characterBlock.id = charId;

          characterBlock.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-lg text-gray-600">Character</h3>
                        <button class="remove-character p-2 rounded-full hover:bg-red-100 remove-btn" data-target="${charId}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="form-label text-sm">Name</label>
                            <input type="text" data-prop="name" class="form-input text-sm" placeholder="e.g., Elara" value="${
                              char.name || ""
                            }">
                        </div>
                        <div>
                            <label class="form-label text-sm">Description</label>
                            <textarea rows="3" data-prop="description" class="form-input text-sm" placeholder="e.g., A grizzled detective, mid-40s...">${
                              char.description || ""
                            }</textarea>
                        </div>
                        <div>
                            <label class="form-label text-sm">Wardrobe</label>
                            <input type="text" data-prop="wardrobe" class="form-input text-sm" placeholder="e.g., Worn trench coat..." value="${
                              char.wardrobe || ""
                            }">
                        </div>
                        <div class="pt-2">
                             <button class="flesh-out-character w-full text-sm bg-teal-500 text-white font-semibold py-1.5 px-2 rounded hover:bg-teal-600 transition-colors flex items-center justify-center disabled:bg-teal-300">
                                <span class="btn-text">âœ¨ Flesh out Character</span>
                                <div class="loader small-loader hidden"></div>
                            </button>
                        </div>
                    </div>
                `;
          charactersContainer.appendChild(characterBlock);
        }

        // --- API Call Functions ---

        async function callApi(url, payload) {
          // Implement exponential backoff for retries
          let response;
          let delay = 1000;
          for (let i = 0; i < 5; i++) {
            try {
              response = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              });
              if (response.ok) {
                return await response.json();
              }
              if (response.status === 429 || response.status >= 500) {
                // Throttling or server error, wait and retry
                await new Promise((resolve) => setTimeout(resolve, delay));
                delay *= 2;
              } else {
                // Other client-side error, don't retry
                break;
              }
            } catch (error) {
              // Network error, wait and retry
              await new Promise((resolve) => setTimeout(resolve, delay));
              delay *= 2;
            }
          }
          throw new Error(
            `API Error: ${response.status} ${response.statusText}`
          );
        }

        async function callGeminiToPopulate() {
          const sceneDescription = sceneDescriptionInput.value;
          if (!sceneDescription.trim()) {
            apiError.textContent = "Please enter a scene description first.";
            return;
          }
          setLoading(generateDetailsBtn, true);
          apiError.textContent = "";

          const schema = {
            type: "OBJECT",
            properties: {
              scene_details: {
                type: "OBJECT",
                properties: {
                  action: {
                    type: "STRING",
                    description:
                      "A detailed description of the primary action occurring in the scene.",
                  },
                },
              },
              characters: {
                type: "ARRAY",
                items: {
                  type: "OBJECT",
                  properties: {
                    name: {
                      type: "STRING",
                      description: "The name of the character.",
                    },
                    description: {
                      type: "STRING",
                      description:
                        "A detailed physical and personality description of the character.",
                    },
                    wardrobe: {
                      type: "STRING",
                      description:
                        "A description of what the character is wearing.",
                    },
                  },
                },
              },
              environment: {
                type: "OBJECT",
                properties: {
                  location: {
                    type: "STRING",
                    description: "The main location of the scene.",
                  },
                  time_of_day: {
                    type: "STRING",
                    description:
                      "The time of day, including weather conditions.",
                  },
                  atmosphere: {
                    type: "STRING",
                    description: "The mood or feeling of the scene.",
                  },
                  props: {
                    type: "STRING",
                    description: "Key objects present in the scene.",
                  },
                },
              },
              cinematography: {
                type: "OBJECT",
                properties: {
                  shot_type: {
                    type: "STRING",
                    description:
                      "The camera shot type (e.g., Wide shot, Close-up).",
                  },
                  camera_motion: {
                    type: "STRING",
                    description:
                      "How the camera is moving (e.g., Static, Pan left).",
                  },
                  lighting: {
                    type: "STRING",
                    description:
                      "The lighting style (e.g., High contrast, Soft light).",
                  },
                  style: {
                    type: "STRING",
                    description:
                      "The overall visual style (e.g., Film noir, Anime).",
                  },
                  color_palette: {
                    type: "STRING",
                    description: "The dominant colors of the scene.",
                  },
                },
              },
              audio: {
                type: "OBJECT",
                properties: {
                  dialogue: {
                    type: "OBJECT",
                    properties: {
                      character: {
                        type: "STRING",
                        description: "The name of the character speaking.",
                      },
                      line: {
                        type: "STRING",
                        description: "The line of dialogue.",
                      },
                    },
                  },
                  sound_effects: {
                    type: "STRING",
                    description: "Specific sound effects that should be heard.",
                  },
                  ambient_noise: {
                    type: "STRING",
                    description: "The background sound or music of the scene.",
                  },
                },
              },
            },
          };
          const systemPrompt = `You are a helpful assistant for a video director. Analyze the user's scene description and extract the key details. Populate the JSON schema with as much detail as possible based on the user's text. Infer reasonable details if they are implied but not explicitly stated. For example, if the user mentions 'film noir', you can infer high-contrast lighting.`;
          const payload = {
            contents: [{ parts: [{ text: sceneDescription }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
            generationConfig: {
              responseMimeType: "application/json",
              responseSchema: schema,
            },
          };

          try {
            const result = await callApi(geminiApiUrl, payload);
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

            if (!jsonText) {
              // Check for safety blocks and provide a more informative error.
              const blockReason = result?.promptFeedback?.blockReason;
              if (blockReason) {
                throw new Error(
                  `Request blocked by safety filters. Reason: ${blockReason}. Please revise your prompt.`
                );
              }
              // Add a general console log for unexpected responses
              console.error("Unexpected API Response:", result);
              throw new Error(
                "No content received from API. The response may have been empty or blocked."
              );
            }

            const parsedJson = JSON.parse(jsonText);
            populateForm(parsedJson);

            // --- AUTOMATIC SCENE IMAGE GENERATION ---
            // Use the original, full scene description to generate a representative image.
            imagePromptInput.value = sceneDescription;
            await callNanaBananaToGenerateImage();
            // --- END AUTOMATIC SCENE IMAGE GENERATION ---
          } catch (error) {
            console.error("Error populating form:", error);
            apiError.textContent =
              "Failed to generate details. " + error.message;
          } finally {
            setLoading(generateDetailsBtn, false);
          }
        }

        async function callGeminiForCharacter(button) {
          const characterBlock = button.closest(".character-block");
          const name = characterBlock.querySelector('[data-prop="name"]').value;
          const description = characterBlock.querySelector(
            '[data-prop="description"]'
          ).value;

          if (!name && !description) {
            alert(
              "Please provide at least a name or description for the character."
            );
            return;
          }
          setLoading(button, true);

          const systemPrompt = `You are an expert character designer. Based on the provided character details, generate a richer, more detailed physical description and a specific, fitting wardrobe. Respond ONLY with a JSON object containing two keys: 'newDescription' and 'newWardrobe'.`;
          const userPrompt = `Character Name: ${name}\nCurrent Description: ${description}`;
          const payload = {
            contents: [{ parts: [{ text: userPrompt }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
            generationConfig: {
              responseMimeType: "application/json",
              responseSchema: {
                type: "OBJECT",
                properties: {
                  newDescription: { type: "STRING" },
                  newWardrobe: { type: "STRING" },
                },
              },
            },
          };

          try {
            const result = await callApi(geminiApiUrl, payload);
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!jsonText) throw new Error("No content received from API.");
            const parsedResult = JSON.parse(jsonText);

            characterBlock.querySelector('[data-prop="description"]').value =
              parsedResult.newDescription || description;
            characterBlock.querySelector('[data-prop="wardrobe"]').value =
              parsedResult.newWardrobe || "";
            updateJsonOutput();
          } catch (error) {
            console.error("Error fleshing out character:", error);
            alert("Could not generate character details. Please try again.");
          } finally {
            setLoading(button, false);
          }
        }

        async function callGeminiForDialogue() {
          const dialogueCharacter =
            document.getElementById("dialogue_character").value;
          if (!dialogueCharacter) {
            alert(
              "Please enter a character name in the 'Dialogue Character' field first."
            );
            return;
          }
          setLoading(suggestDialogueBtn, true);

          // Gather context from the form
          const context = {
            action: document.getElementById("action").value,
            location: document.getElementById("location").value,
            atmosphere: document.getElementById("atmosphere").value,
            speakingCharacter: {
              name: dialogueCharacter,
              description:
                promptData.characters.find((c) => c.name === dialogueCharacter)
                  ?.description || "No description available.",
            },
          };

          const systemPrompt = `You are a master screenwriter. Based on the provided scene context and character, write a single, impactful line of dialogue for them. The line should be concise and fitting for the scene's mood. Respond ONLY with a JSON object containing one key: 'dialogueLine'.`;
          const userPrompt = `Scene Context: ${JSON.stringify(
            context,
            null,
            2
          )}`;
          const payload = {
            contents: [{ parts: [{ text: userPrompt }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
            generationConfig: {
              responseMimeType: "application/json",
              responseSchema: {
                type: "OBJECT",
                properties: { dialogueLine: { type: "STRING" } },
              },
            },
          };

          try {
            const result = await callApi(geminiApiUrl, payload);
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!jsonText) throw new Error("No content received from API.");
            const parsedResult = JSON.parse(jsonText);
            document.getElementById("dialogue_line").value =
              parsedResult.dialogueLine || "";
            updateJsonOutput();
          } catch (error) {
            console.error("Error suggesting dialogue:", error);
            alert("Could not suggest dialogue. Please try again.");
          } finally {
            setLoading(suggestDialogueBtn, false);
          }
        }

        async function callNanaBananaToGenerateImage() {
          const imagePrompt = imagePromptInput.value;
          if (!imagePrompt.trim()) {
            // This function is now called automatically, so we don't show an alert
            // if the prompt is empty. It just won't run.
            return;
          }
          setLoading(generateImageBtn, true);
          imagePlaceholder.classList.add("hidden");
          generatedImage.classList.add("hidden");
          imageLoader.classList.remove("hidden");
          downloadImageLink.classList.add("hidden");

          // Add the aspect ratio instruction directly to the prompt.
          const promptWithAspectRatio =
            imagePrompt +
            ". Generate the image in a 9:16 vertical aspect ratio, suitable for mobile video.";

          const payload = {
            contents: [
              {
                parts: [{ text: promptWithAspectRatio }],
              },
            ],
            generationConfig: {
              responseModalities: ["TEXT", "IMAGE"],
            },
          };

          try {
            const result = await callApi(nanaBananaApiUrl, payload);
            const base64Data = result?.candidates?.[0]?.content?.parts?.find(
              (p) => p.inlineData
            )?.inlineData?.data;

            if (base64Data) {
              const imageData = `data:image/png;base64,${base64Data}`;
              generatedImage.src = imageData;
              imageUrlInput.value = `data:image/png;base64,... (Generated via Nana Banana for scene: '${imagePrompt.substring(
                0,
                30
              )}...')`;
              generatedImage.classList.remove("hidden");
              downloadImageLink.href = imageData;
              downloadImageLink.classList.remove("hidden");
              updateJsonOutput();
            } else {
              downloadImageLink.classList.add("hidden");
              throw new Error(
                "No image data in API response from Nana Banana."
              );
            }
          } catch (error) {
            console.error("Error generating image:", error);
            alert(
              "Failed to generate image. Please check the console for details."
            );
            imagePlaceholder.classList.remove("hidden");
            downloadImageLink.classList.add("hidden");
          } finally {
            setLoading(generateImageBtn, false);
            imageLoader.classList.add("hidden");
          }
        }

        // --- UI and Event Handling ---

        function populateForm(data) {
          charactersContainer.innerHTML = "";
          characterCount = 0;
          document.getElementById("action").value =
            data.scene_details?.action || "";
          (data.characters && data.characters.length
            ? data.characters
            : [{}]
          ).forEach(addCharacter);
          const env = data.environment || {};
          Object.keys(env).forEach((key) => {
            if (document.getElementById(key))
              document.getElementById(key).value = env[key] || "";
          });
          const cine = data.cinematography || {};
          Object.keys(cine).forEach((key) => {
            if (document.getElementById(key) && key !== "style")
              document.getElementById(key).value = cine[key] || "";
          });

          // Handle style dropdown population
          const styleValue = cine.style || "Cinematic";
          const styleOptions = Array.from(styleSelect.options).map(
            (opt) => opt.value
          );
          if (styleOptions.includes(styleValue)) {
            styleSelect.value = styleValue;
            styleOtherInput.classList.add("hidden");
          } else {
            styleSelect.value = "Other";
            styleOtherInput.value = styleValue;
            styleOtherInput.classList.remove("hidden");
          }

          const audio = data.audio || {};
          document.getElementById("dialogue_character").value =
            audio.dialogue?.character || "";
          document.getElementById("dialogue_line").value =
            audio.dialogue?.line || "";
          document.getElementById("sound_effects").value =
            audio.sound_effects || "";
          document.getElementById("ambient_noise").value =
            audio.ambient_noise || "";
          updateJsonOutput();
        }

        function setLoading(button, isLoading) {
          button.disabled = isLoading;
          const text = button.querySelector(".btn-text, span");
          const loader = button.querySelector(".loader");
          if (isLoading) {
            text?.classList.add("hidden");
            loader?.classList.remove("hidden");
          } else {
            text?.classList.remove("hidden");
            loader?.classList.add("hidden");
          }
        }

        formContainer.addEventListener("input", updateJsonOutput);
        addCharacterBtn.addEventListener("click", () => addCharacter());
        generateDetailsBtn.addEventListener("click", callGeminiToPopulate);
        suggestDialogueBtn.addEventListener("click", callGeminiForDialogue);
        generateImageBtn.addEventListener(
          "click",
          callNanaBananaToGenerateImage
        );

        charactersContainer.addEventListener("click", (e) => {
          const removeBtn = e.target.closest(".remove-character");
          const fleshOutBtn = e.target.closest(".flesh-out-character");
          if (removeBtn) {
            document.getElementById(removeBtn.dataset.target)?.remove();
            updateJsonOutput();
          } else if (fleshOutBtn) {
            callGeminiForCharacter(fleshOutBtn);
          }
        });

        styleSelect.addEventListener("change", () => {
          if (styleSelect.value === "Other") {
            styleOtherInput.classList.remove("hidden");
          } else {
            styleOtherInput.classList.add("hidden");
          }
          updateJsonOutput();
        });

        copyJsonBtn.addEventListener("click", () => {
          const jsonText = JSON.stringify(
            JSON.parse(jsonOutput.textContent),
            null,
            2
          );
          const textArea = document.createElement("textarea");
          textArea.value = jsonText;
          document.body.appendChild(textArea);
          textArea.select();
          try {
            document.execCommand("copy");
            copyFeedback.textContent = "Copied to clipboard!";
          } catch (err) {
            copyFeedback.textContent = "Failed to copy!";
          }
          document.body.removeChild(textArea);
          setTimeout(() => {
            copyFeedback.textContent = "";
          }, 2000);
        });

        // Initial state
        addCharacter();
        updateJsonOutput();
      });
    </script>
  </body>
</html>
